\chapter{Aspectos particulares de la solución}

\section{Ciclo de vida de un pedido}
Desde que el pedido es ingresado de alguna de las diversas maneras posibles, hasta que el cliente puede disfrutarlo, se suceden diversos estados, en lo que denominamos el ciclo de vida de un pedido.

Los estados en los que puede encontrarse un pedido una vez que ingresó al sistema son:
\begin{itemize}
\item Ingresado: El pedido pasó los chequeos necesarios, se determinó que es posible llevarlo a cabo con éxito y se ingresó al sistema, yendo a parar a una cola donde espera a que la cocina esté lista para prepararlo.
\item	En preparación: El pedido ya fue recibido por la cocina y está siendo preparado por un cocinero.
\item	Preparado: El pedido ya fue preparado en su totalidad y está listo para ingresar al horno cuando haya lugar disponible.
\item	En el horno: El pedido (o al menos una de sus partes) está en el horno.
\item	Listo: El pedido está listo para ser entregado al cliente.
\item	Enviado: El pedido fue entregado al delivery para su entrega a domicilio.
\item	Finalizado: El pedido fue entregado con éxito (ya sea a la mesa o a domicilio).
\item	Cancelado: El pedido fue cancelado antes de su entrega.
\end{itemize}

En breve, un proceso ingresa al sistema cuando es requerido por un cliente por algún medio de comunicación. Enseguida se indica a la cocina que el pedido debe ser preparado. Una vez completada la preparación de la comida, los responsables de cocina lo indican al sistema que planifica de forma independiente la asignación de lugares en los hornos. Finalmente, después de que el pedido es horneado, se entrega a la mesa o al delivery según corresponda. Por último cuando existe confirmación de la entrega se marca el pedido como finalizado y se almacena con fines de registro. El pedido puede ser cancelado en cualquier punto (salvo después de ser finalizado), con implicaciones varias en el sistema de control de stock.

Los estados presentados tienen utilidad para el sistema puesto que hay necesidad de indicar al cliente sobre el estado de su pedido. Así, se podrá indicar si un pedido está siendo preparado o ya fue enviado al destinatario. Si bien para estos fines alcanza con 3 estados (preparando, enviando, finalizado), se agregan los demás con fines de control para el sistema. Además, la granularidad más fina permite al sistema hacer predicciones y organizaciones más eficientes del uso de los recursos. Por ejemplo, al controlar los tiempos de preparación por separado de los de horneado resulta más sencillo, en caso de un cuello de botella en la cocina, determinar cual es el factor limitante.


La figura \ref{cicloPedido} nos ilustra este ciclo de vida.

\begin{figure}[H]
\centering
\includegraphics[width=17cm]{./figuras/ciclo_pedido}
\caption{Ciclo de vida de un pedido}
\label{cicloPedido}
\end{figure}

A lo largo de las siguientes secciones se desarrollaran los diferentes aspectos de cada momento en la vida de un pedido, asi como otros aspectos relaciones a los pedidos.

\section{Ingreso de pedidos}
Los pedidos basicamente pueden ser remotos o locales. Los pedidos remotos se pueden realizar via telefonica, via web, o via sms.

Todos los pedidos tienen un único horno asignado, con la excepción de los pedidos de solo bebidas, a los que no se les asigna ningún horno.

En todos los ingresos de pedidos, se realiza un chequeo de la disponibilidad del stock, a fin de evitar tomar pedidos que no se pueden satisfacer. La siguiente fsm presenta un modelo del control de stock para el ingreso de pedidos.

Supongamos que en la pizzeria hay hasta $k$ pedidos, hay $e$ tipos de empanadas y $i$ pizzas,
consideremos las siguientes variables:
stock pizza 1 : $[0...MAX_{STOCK}]$,
...
stock pizza i : $[0...Max_{STOCK}]$,
stock empanada 1 : $[0...MAX_{STOCK}]$,
...
stock empanada e : $[0...Max_{STOCK}]$,
stock stock bollo : $[0...MAX_{STOCK}]$,
stock stock tapas : $[0...Max_{STOCK}]$,

todas ellas comenznado con un valor SSTOCK constante.

pizza 1 1 : $[0...MAX]$
...
pizza 1 k : $[0...MAX]$
pizza 2 1 : $[0...MAX]$
...
pizza i k : $[0...MAX]$

donde pizza n m tiene cuantos kits de pizza del tipo n quiere el pedido m

de forma analoga tenemos las variables:

empanada 1 1 : $[0...MAX]$
...
empanada 1 k : $[0...MAX]$
empanada 2 1 : $[0...MAX]$
...
empanada e k : $[0...MAX]$

que guardan la cantidad de kits de empanadas de cada tipo que quiere cada pedido

pizzas 1 : $[0...MAX]$
...
pizzas k : $[0...MAX]$
indica cuantos bollos de pizza requiere cada pedido

empanadas 1 : $[0...MAX]$
...
empanadas k : $[0...MAX]$
indica cuantas tapas requiere cada pedido.

Entonces, la FSM de la figura \ref{fsmIngresoPedidos} modela el ingreso de pedidos para cada pedido $j = 0 ... k$

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{./figuras/ingresoPedidos}
\caption{FSM ingreso de pedidos j}
\label{fsmIngresoPedidos}
\end{figure}

Lo que nos muestra dicha FSM es que durante el estado de armado de un pedido se seleccionan distintos productos con una cantidad dada de cada uno de ellos. Cuando el pedido esta armado, se intenta hacer el pedido. Entonces el mismo puede ser ingresado, o puede ser cancelado, pudiendo intentar hacer un pedido diferente o desistir.

En la figura \ref{fsmChequeoStock} vemos a la FSM que se encarga de controlar el stock para evitar el ingreso de pedidos no satisfacibles.

Esta fsm se encarga de decidir si el pedido se puede ingresar o no en base a la cantidad de stock y de productos necesarios.

La FSM que regula el ingreso de pedidos en base al stock se obtiene como:
FSM Ingreso Controlado de pedidos = FSM ingreso de pedidos 1 $||$ ... $||$ FSM ingreso de pedidos k $||$ FSM chequeo de stock

Analizando las trazas de la composición, podemos notar que cuando se hace un pedido, la decision de si se puede ingresar o no asi como el decremento del stock es un evento atomico, es decir no puede ocurrir que un pedido se este por ingresar y antes de decrementar el stock se ingresa otro. Situación que podría hacer que se tomen pedidos y luego no se puedan satisfacer.
  
A continuación detalleremos los distintos tipos de pedidos, asi como también describiremos las actividades propias de su ingreso

\begin{figure}[H]
\centering
\includegraphics[scale=0.4]{./figuras/chequeoStock}
\caption{FSM chequeo de stock}
\label{fsmChequeoStock}
\end{figure}

\subsection{Pedidos remotos}
Los pedidos remotos requieren que los usuarios esten registrados en el sistema. Esto se hace por cuestiones de seguridad, a fin de evitar la realización de pedidos por parte de usuarios anonimos que podrian cancelar constantemente o dar direcciones falsas. La registracion de usuarios se realiza personalmente o telefonicamente. Decidimos no permitir regitro de usuarios via web, ya que consideramos que el método no era del todo fiable (es facil crear usuarios ficticios y hacer pedidos en broma).

Si un usuario desea poder hacer pedidos vía web, deberá elegir un nombre de usuario y una contraseña al momento de registrarse, así como proveer una dirección de mail. Si se desean hacer pedidos SMS, el usuario deberá brindar un número de celular, al que se ``autoriza'' para efectuar pedidos a nombre de ese usuario. Para todo tipo de pedidos que involucren delivery, el usuario deberá registrar una dirección (aunque podría tener más de una, existe una única que es predeterminada).

A continuación describiremos los procedimientos para la realización de pedidos remotos.

\subsubsection{Pedidos telefonicos}
El cliente que desee realizar un pedido telefonico debe llamar al número de la pizzería. El encargado de pedidos es el responsable de atender los llamados telefonicos. El cliente debe brindar información de identificación al encargado para permitir individualizarlo (nombre, dirección o nombre de usuario). El encargado corrobora entonces el número desde el que está llamando el usuario para verificar su identidad (eventualmente si llama desde otro número puede identificarse con usuario y password si lo tuviera).

Si el usuario no estaba registrado, el encargado debe sugerirle la posibilidad de registrarse. Si el usuario no esta registrado y no desea registrarse, no se toma el pedido. %TODO: caso de uso chequear datos de usuario

Una vez autentificado el usuario, el mismo procede a dictar su pedido al encargado de pedidos. Una vez finalizado, el encargado de pedidos intenta ingresar el pedido al sistema, el cual se encarga de verificar si es posible satisfacer dicho pedido. En caso de no ser posible el sistema indicara mediante un mensaje de error que el pedido no fue posible de realizar e indicara que producto/s no estaba/n disponible/s. El cliente puede entonces dar un pedido diferente.

Si el pedido sí podía ser tomado, el sistema se encarga de registrar el pedido como ingresado. Se genera un identificador de pedido, se estima el tiempo del mismo y se calcula el costo total. Ademas si el pedido es mixto se brinda la posibilidad de que el encargado de pedidos asigne un horno. %TODO: caso de uso loco

\begin{figure}
\centering
\includegraphics[height=19cm]{./figuras/diagramaActividadTelefono}
\caption{Diagrama de actividad del ingreso de un pedido telefónico}
\end{figure}

%TODO: poner diagrama de actividad
%NOTA: estos casos de uso q aparecen son medio especificos del caso, tonces se podria hacer un diagrama aparte

\subsubsection{Pedidos web}
Para que los clientes puedan realizar pedidos via web, la pizzería contara con una página web. El cliente que desee hacer un pedido por esta vía debe ingresar a la página y autentificarse con usuario y contraseña.

Una vez autentificado, tendra la posibilidad de elegir ingresar pedido. Entonces podra elegir que productos desea y con que cantidad a partir de una lista en línea. Dicha lista solo contiene productos que están disponibles (los que ya están fuera de stock no se incluyen). Cuando marcó lo que deseaba puede ingresar el pedido. Entonces el sistema verifica la viabilidad del pedido, y en caso de no ser posible de realizar lo informa mediante un mensaje indicando que producto no se encuentra disponible. El cliente puede volver a ingresar un pedido diferente si lo desea.

En caso de que sea posible registrar el pedido, se estima el tiempo del mismo y se calcula el costo total. Esta información se muestra al usuario por pantalla. A continuación se le permite al usuario elegir si prefiere pagar contra entrega al delivery o con tarjeta de crédito. Si la operación con tarjeta falla, se muestra un mensaje de error y se permite al usuario reingresar los datos de la misma o cambiar de forma de pago. Hecho esto, se confirma todo el pedido.

Si entre la elección de los productos y la confirmación del pedido se acaba el stock de materias primas, se muestra un error y se vuelve a la pantalla de selección de productos (esto debería ser muy raro). 

Una vez que el pedido fue ingresado, si se pagaba con tarjeta, se hace efectivo el cobro.

El pedido será encolado automáticamente tratando de balancear la carga de los hornos. 

\begin{figure}[H]
\centering
\includegraphics[height=23cm]{./figuras/diagramaActividadWeb}
\caption{Diagrama de actividad del ingreso de un pedido Web}
\end{figure}
%TODO:diagrama de actividad

\subsubsection{Pedidos SMS}
El cliente que desee realizar un pedido via sms debe enviar un mensaje al servidor sms de la pizzeria, junto con el pedido que quiere hacer. Si el celular no estaba registrado, el sistema descarta el pedido y le envia un mensaje sms al mismo sugiriendole registrarse por telefono o personalmente.

Para identificar los productos que desea pedir, el cliente cuenta con un catálogo con códigos de producto y de ``combos'' populares ya sea en papel o consultable via Internet.

El sistema verifica si es posible satisfacer el pedido. En caso de no ser posible el sistema le envia un mensaje al cliente para avisar que el pedido no podra ser satisfecho, indicando que producto no esta disponible. Si el pedido sí podía ser tomado, el sistema lo registra como ingresado, genera un identificador de pedido, estima el tiempo del mismo, calcula el costo total y luego de todo esto procede a enviarle un mensaje de respuesta de sms con esos datos al cliente. 

\begin{figure}[H]
\centering
\includegraphics[height=17cm]{./figuras/diagramaActividadSMS}
\caption{Diagrama de actividad del ingreso de un pedido SMS}
\end{figure}

\subsection{Pedidos locales}
Los pedidos locales pueden realizarse a los mozos, quienes cuentan con una PDA para realizar el registro de los pedidos. Un cliente dicta su pedido a algún mozo, el cual marca los productos y sus cantidades en su PDA. una vez que el cliente dictó su pedido el mozo ingresa el pedido. El sistema verifica la factibilidad del mismo, si no es posible tomarlo, notifica al mozo para que informe de la situación al cliente.

\begin{figure}[H]
\centering
\includegraphics[height=11cm]{./figuras/diagramaActividadMozo.png}
\caption{Diagrama de actividad de toma de un pedido por parte del mozo}
\end{figure}

Si es posible ingresar el pedido el sistema genera el id del pedido, se estima el tiempo del mismo y se calcula el costo total. La asignación del horno es también responsabilidad del sistema.

Por otro lado, un pedido local (de mostrador) se solicita al encargado de pedidos, quien registra los productos del pedido de manera similar a como registra los pedidos telefonicos, con le excepción de que en este caso podía no tener los datos del usuario.

%TODO:diagrama de actividad de ambos casos
\begin{figure}[H]
\centering
\includegraphics[height=12cm]{./figuras/pantallaBotonesMozo.png}
\caption{Interfaz del mozo para ingreso y cierre de pedido}
\end{figure}

\section{Registro de usuarios}
El registro de usuarios es responsabilidad del encargado de pedidos, y se realiza por via telefonica asi como también personalmente. 

Para registrar a un usuario el encargado de pedidos debe tomar los siguientes datos:
\begin{itemize}
\item Nombre
\item Apellido
\item Dirección
\item Telefono
\item Usuario, password (opcional, solo necesario para hacer pedidos via Web)
\item E-Mail (opcional)
\item Célular (opcional, solo necesario para poder hacer pedidos vis SMS)
\end{itemize}

Una vez registrado el usuario puede en otro momento solicitar modificar algun dato, o agregar algun dato opcional.
%TODO: pantalla
Veamos operacionalmente como funciona el registro de un usuario:

La siguiente operación permite registrar un usuario nuevo sin datos web ni SMS

\begin{funcion}{RegistroUsuario}{nombreC: String, apellidoC: String, CalleC: String, NumeroC: Integer}{}{}
   \precond{True}
   
   \poscond{Cliente.allinstances() $\rightarrow$ size() = Cliente@pre.allinstances() $\rightarrow$ size+1}
   
   \poscond{(Cliente.allinstances() -  Cliente@pre.allinstances()) $\rightarrow$ forall(c | c.oclIsNew() and c.Nombre = nombreC and c.apellido = apellidoC and c.calle = CalleC and c.Numero = NumeroC)} 
   
\end{funcion}

Si queremos agregar datos web a un usuario, se utiliza la siguiente operacion

\begin{funcion}{RegistroUsuario}{c:Cliente, nick:String, clave:String}{}{}
   \precond{DatoWeb@pre.allinstances().pass$\rightarrow$ includes(nick)}
   \precond{c.userYPass()$\rightarrow$ isEmpty()}
   
   \poscond{DatoWeb.allinstances() $\rightarrow$ size() = DatoWeb@pre.allinstances() $\rightarrow$ size+1}
   \poscond{(DatoWeb.allinstances() - DatoWeb@pre.allinstances())$\rightarrow$ forall(d | d.usr = nick and d.pass = clave and d.datosDe = c)}
\end{funcion}

De forma similar se puede definir una operacion que agregue datos para realizar pedidos por SMS.

\section{Facturacion}
La facturación de los pedidos de la pizzería esta a cargo del software de facturación que posee el establecimiento. El sistema solo provee de la facilidad de generar un archivo con los datos necesarios para realizar la factura cuando el cajero lo determine adecuado. 

El archivo se genera cuando un pedido esta listo para salir a entrega en el caso de que el mismo sea con delivery o mostrador, o en el momento en el que el cliente pide la cuenta al mozo. %TODO: caso de uso

A la hora de generar el archivo la forma de pago de los pedidos en alguna mesa debe ser ingresada por el mozo, tras preguntarsela al cliente. En este caso, el archivo se genera con los campos nombre de usuario, apellido y número de cliente en blanco. En el caso de los pedidos via SMS o telefonicos, estos se pagan en efectivo al delivery. Por otro lado, para los pedidos via web, la forma de pago la determina el usuario.

%FSM de cuando como es la generación de las facturas

\section{Cancelación}
La cancelación de un pedido se realiza via telefonica o personalmente. Una cancelación se puede realizar siempre y cuando no se haya entregado el pedido, es decir que el pedido no se encuente en estado finalizado. 

Los productos ya elaborados, se descartan al cancelarse el pedido. En cambio los insumos no utilizados regresan al stock.
Dado que no se informa cada producto que se prepara, por ejemplo si hay que hacer 6 empanadas el maestro no notifica cada vez que arma una, podria ocurrir que el pedido se cancele mientras esta siendo preparado. En este caso el sistema muestra almaestro un mensaje informandole que el pedido se cancelo, y pidiendole que indique que parte de los insumos se puede reutilizar. Para pedidos mixtos el tratamiento de esta situación es individual para cada cocinero. %TODO:agregar flecha al diag de contexto

Para cancelar un pedido via telefonica el usuario debe identificarse, y luego debe indicar que pedido quiere cancelar. En caso de un pedido hecho en el local, el cliente debe avisar al mozo, que notifica al encargado de pedidos, quien cancela el pedido, o directamente al encargado de pedidos.

También se considera cancelado un pedido que no se pudo entregar por delivery.

%FSM de como es la onda de las cancelaciones

\section{Cola de pedidos}
Por cola de pedidos se entiende la cola que determina el orden en el cual se prepararan los pedidos ingresados al sistema. La cola es la que determina que pedido ingresado debe comenzar a preparse a continuación. Dicha cola se gestiona de manera automatica, pero puede ser modificada por el encargado de pedidos. Ni bien un producto pasa a preparse, es decir se comienza a preparar cualquiera de sus partes el mismo deja de estar en esta cola.

Cuando todas las partes de un pedido fueron preparados, el pedido deja de estar en preparación para pasar a estar en estado de preparado.

A continuación, mostramos algunos prototipos de pantalla de la interfaz que tendra el encargado de pedidos con la cola
\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{./figuras/pantallaColaPedido3.png}
\caption{Prototipo de la vista de la cola de pedidos del encargado. El puede mover un pedido dandole mas o menos prioridad, en el ejemplo dio mas prioridad al pedido 4 recien ingresado}
\end{figure}

%operacion pedir proximo pedido a preparar
%TODO: aca hay que hacer diagramas seguro, pero no se me ocurren

\section{Cola de horno} 
La cola del horno es la cola que establece que pedido (que parte del mismo) se cocinara a continuación. La cola se gestiona también de manera automática. El maestro indica cuando saca algo de un pedido. El sistema informa que debe colocar al horno entonces. A partir del momento en que alguna parte del pedido es indicada para entrar al horno, el pedido pasa a ser considerado al horno. El sistema identifica que parte esta realmente en el horno, que parte aun no ingreso y que parte ya fue cocinada. Cuando todas las partes del pedido fueron cocinadas, se considera que el pedido fue cocinado. 

El sistema muestra que debe de colocarse en el horno. Cuando el maestro saca algo del horno, debe indicarselo al sistema a fin de que este pueda establecer que poner a continuación.

La cola ingreso al horno admite varias politicas, una de ella es la de sectores agiles. En este caso, algunos modulos funcionan como modulos agiles y dan prioridad a los pedidos mas chicos. Es decir, que cuando se libera un modulo agil y el maestro pide que producto debe ingresar, el sistema tendra en cuenta la existencia de pedidos mas chicos que se puedan ingresar por completo al horno. 

El cambio de politica es ingresado por el encargado de pedidos, quien al cambiar la politica a sectores agiles, debe ingresar cuales son los modulos agiles. Las políticas de horno no se modifican a lo largo del día (se elige al iniciar el sistema por la mañana). Además, es global (no es por horno).

El tamaño y cantidad de los módulos del horno es configurable, sin embargo no se considera necesario un caso de uso para hacer esto. Lo mismo ocurre con la definición de pedido ``chico''.

A continuación veremos en un diagrama de actividad las actividades que se producen cuando uno de los maestros indica que cocinó ciertos productos de un pedido. En el diagrama se nombra como pedido actual a aquel al cual pertenecen los productos que el maestro acaba de informar que termino de cocinar, ademas se considera que hay pedidos en la cola, de modo que el sistema debe informarle al maestro que poner a continuación, esto no ocurre siempre, ya que si cuando el maestro informa que cocino algo no hay nada en la cola del horno, el sistema no le informa que poner sino hasta que exista algun pedido que deba ingresar al horno.


\begin{figure}[H]
\centering
\includegraphics[scale=0.4]{figuras/actividadProxPedido.png}
\caption{Diagrama de actividad al informar productos cocinados}
\end{figure}

Lo que observamos es que en caso de politica agil el sistema debe ser informado de cuantos modulos agiles fueron liberados, esto podria evitarse si el sistema tuviera noción de que hay en cada modulo (ver posibilidades de mejora \ref{Extensiones}). Cuando se esta en politica agil lo que hace el sistema es buscar ocupar los modulos agiles, en la medida que se liberan, con pedidos chicos. En el caso de politica agil, puede ocurrir que existan dos pedidos con productos afuera del horno y dentro del horno. Por eso en el diagrama dice pedido actual y pedido chico actual. El pedido chico actual es un pedido chico que entro a cocinarse porque se libero algun modulo agil, pero quedo con alguno/s de sus productos sin cocinar

%Diagrama de actividad pedir proximo pedido

\section{Consulta de estado de pedidos}

Tanto el cliente como el encargado de pedidos pueden consultar el estado de un pedido determinado. El cliente puede hacerlo via web o mediante el encargado de pedidos por una llamada telefonica. Para consultar el estado de un pedido via web, el usuario tiene que autentificarse primero. Una vez autentificado podra acceder a la opción de consultar estado de sus pedidos. El sistema lista entonces los pedidos del usuario pendientes de entrega con su estado. 

Por otro lado, de manera similar el encargado de pedidos puede ingresar un número de pedido para revisar su estado o ver los pedidos de un cliente.

%TODO: operacion del calculo de los tiempos

\section{Delivery}

El delivery posee una unica interacción con el sistema. Cuando entrega un pedido, debe enviar un mensaje SMS al sistema notificando la entrega del mismo.

Si el pedido no se pudo entregar el delivery debe notificarselo al encargado de pedidos, y el pedido pasara a ser considerado como cancelado

%todo: diagrama de actividad de entrega de pedidos


%\section{Alternativa de contingencia}
%El sistema posee la capacidad de funcionar en lo que denominamos modo de contingencia. Este modo esta pensado para premitir que el sistema siga siendo funcional aun cuando solo este disponible el puesto del encargado de pedidos.
  
%El sistema permite que toda la operatoria relacionada con la gestión y seguimiento de pedidos (recepción, asignación de horno, armado, ingreso y salida de horno, despacho, control de entrega, actualización de lista de precios) se lleve adelante en el puesto del encargado de pedidos.

%En el modo de contingencia se considera que el software de facturación no esta disponible, por lo cual la facturación se realiza manualmente. Queda ademas fuera de este modo la consulta de estadisticas, asi como también la interacción directa del sistema con mozos, clientes y delivery.

%De esta manera el encargado de pedidos es el único agente que utiliza el sistema cuando se encuentra en este modo. Los clientes pueden hacer pedidos solo telefonicamente o en local a un mozo, mientras que los mozos deben comunicar el pedido al encargado para que este lo ingrese.

%De manera similar, los maestros deberan pedirle al encargado de pedidos que deben cocinar,preparar, asi como también informarle cuando terminaron de preparar algo o de cocinarlo.

%El delivery que en general utiliza SMS para informar al sistema la entrega de un pedido, ahora debera hacerlo comunicandose con el encargado de pedidos.

%Finalmente el dueño deberá informar al encargado de pedido los precios que pretende modificar.
\section{Alternativa de contingencia}
\label{alternativacontingencia}
\subsection{Diagrama de contexto del funcionamiento de contingencia}
%\begin{landscape}
%\begin{figure}[H]
%\centering
%\includegraphics[height=17cm]{ContextoContingencia.png}
%\end{figure}
%\end{landscape}

Del diagrama observamos como las funciones principales en las que antes interactuaban otros agentes con el sistema, ahora son responsabilidad del encargado de pedidos, el cual suma a sus responsabilidades previas, tales como el ingreso de pedidos telefonicos, otras antes ajenas como informar pedidos preparados, etc.

Es muy importante notar la sobrecarga de trabajo del encargado de pedidos. La cantidad de tareas que debe desarrollar lo convierten en un cuello de botella para el funcionamiento de la pizzería, sin embargo dado que este escenario es para un caso de contingencia, en teoria un caso improbable, esta sobrecarga del encargado puede ser tolerada.

\subsection{Casos de uso contingencia}

A continuación se presentan brevemente los casos de uso presentes cuando el sistema esta en estado de contingencia

\begin{figure}[H]
\centering
\includegraphics[height=16cm]{./figuras/casosDeUsoContingencia.png}
\end{figure}

El sistema posee la capacidad de funcionar en lo que denominamos modo de contingencia. Este modo esta pensado para permitir que siga siendo funcional a'un cuando solo est'e disponible el puesto del encargado de pedidos.
Podemos ver en el diagrama de contexto de contingencia el aumento de la densidad de eventos, con respecto al modo normal, que son controlados y monitoreados por el encargado de pedidos. Todas las responsabilidades que ten'ian los dem'as actores y que eran llevadas a cabo desde otras terminales del sistema ahora son tareas que los mismos deber'an llevar a cabo a trav'es del encargado de pedidos, ya que solo su terminal se mantiene en funcionamiento.

A continuaci'on describiremos brevemente los casos de uso en modo contingencia:
\begin{itemize}
\item Indicando pedido preparado y Indicando producto cocinado: el maestro le avisa al encargado de pedidos que termin'o la preparaci'on/cocci'on del pedido o producto y luego el encargado de pedidos procede a registrar tal evento en el sistema.
\item Siendo informado de proximo pedido a preparar y Siendo informado de proximo producto a cocinar: el encargado de pedidos solicita al sistema el proximo pedido/producto a preparar/cocinar y luego se lo informa al maestro.
\item Notificando pedido entregado: el delivery, al no poder enviar un mensaje al sistema para que registre la entrega (o cancelaci'on) del pedido, deber'a avisarle al encargado de pedidos para que este cambie el estado del mismo.
\item Modificando precios: el cajero o dueño desea cambiar el precio de los productos, para esto debe informarle al encargado de pedidos los datos necesarios para realizar la operaci'on. Este caso de uso reemplaza a Realizando ABM de productos, ya que hacer baja o alta de un producto no es una operacion cr'itica durante contingencia.
\item Notificando pedido despachado, Registrando cliente, Consultando estado de pedido y Cancelando pedido: estos casos de uso quedan igual a los casos en modo normal.
\item Registrando pedido: este caso de uso reemplaza a Registrando pedido telef'onico y Registrando pedido de mostrador. Su funcionamiento es igual a los anteriores.
\item Haciendo ABM de stock y Siendo notificado de stock cr'itico: ahora el encargado de pedidos asume las responsabilidades del encargado de stock. Estos son los mismos casos de uso que antes, aunque el actor es el encargado de pedidos.
\end{itemize}

Notese que la geeración de archivo para facturaci'on en modo contingencia no est'a a cargo del sistema, por lo cual se realiza manualmente y est'a a cargo del cajero, como se puede ver en el diagrama de contexto de contingencia. Tambi'en queda fuera de este modo la consulta de estad'isticas, los pedidos por sms y, como ya fue dicho, el alta y baja de productos, ya que no son necesidades cr'iticas durante contingencia.

Los casos de uso de la alternativa de contingencia, son los que permiten satisfacer los requerimientos 16,17 y 18, ya que estos requerimientos eran los que establecian que el sistema debería ser capaz de funcionar con solo el puesto del encargado en estado funcional.

\section{Informacion estadística}
%FIXME: hay cosas q para calcularlas necesitamos info q no tenemos (segun el diag de concepto)
Con el fin de comprender más profundamente el comportamiento del negocio, desarrollamos para la pizzería un conjunto de indicadores que permitan analizar su rendimiento y predecir algunos de los parámetros que afectan su comportamiento, así como optimizar algunas estrategias de venta y producción.

Los indicadores de rendimiento tienen por objetivo caracterizar el funcionamiento de la pizzería en un período dado. Mediante el monitoreo del ingreso y salida de los pedidos, es posible realizar un seguimiento de algunos parámetros interesantes:
\begin{itemize}
\item \textbf{Tasa de producción de la cocina}: Permite evaluar el la capacidad de la cocina de atender pedidos, con el objeto de determinar sus posibilidades de producción y evaluar si en un momento dado la cocina funciona por debajo o por encima de su nivel habitual.
\item \textbf{Tasa de ingreso de pedidos}: Permite conocer la demanda que hubo en un momento dado y con esa información inferir la demanda de momentos futuros. Puede medirse de forma global o discriminada por origen de pedido, permitiendo observar cual es la forma más utilizada para ingresarlos.
\item \textbf{Tiempo medio de espera por un pedido}: Permite conocer el tiempo que debe esperar un cliente por su pedido en función del momento en que realizó su pedido. Puede medirse de forma discriminada para clientes locales o remotos.
\item \textbf{``Combos'' más populares}: Permite conocer algunos conjuntos de productos que suelen ser ordenados juntos por los clientes. 
\item \textbf{ ``Perfiles'' de cliente}: Permite evaluar los tipos de compras que realiza cada cliente gracias a la información personalizada que se tiene sobre cada uno. 
\item \textbf{Productos más populares}: Permite conocer cuales son los productos que circulan con mayor frecuencia y por tanto deberían ser considerados más importantes para cuestiones tales como la ubicación de los mismos en la carta.
\end{itemize}

En particular, el conocimiento sobre la demanda permite mantener un menor stock de productos, disminuyendo así el costo financiero y manteniendo una mayor eficiencia en la administración de los recursos. A su vez, determinar los productos y combinaciones más populares puede conducir a promociones más efectivas, así como a disminuciones de costos por un mejor conocimiento de los insumos necesarios para su producción. Por último, los perfiles de cliente permiten ejecutar estrategias de fidelización: al conocer en detalle y de forma individual las compras que realiza cada cliente se puede determinar cuales son los clientes más importantes y en función de eso ofrecerles algún tipo de beneficio.

\section{Modificación de precios}
La modificación de precios puede ser realizada por el dueño, o por el cajero. Para modificar precios se utiliza el sistema de ABM de productos que provee el sistema. (ver ABM de productos)

\section{ABM de productos}
El ABM de productos, permite ingresar nuevos productos, es decir nuevas variedades de pizzas, empanadas, etc. Al ingresar un nuevo producto se debe ingresar un tiempo estimado de cocción y preparación. Por otro lado también se puede modificar los precios de los productos existentes, que no afectan a los pedidos ya registrados. Finalmente, también se puede dar de baja productos, por ejemplo productos que se venden muy poco.

%TODO: hacer operaciones abm

\section{ABM de stock}
El ABM de stock permite realizar altas, bajas y modificaciones de los kits y demas insumos para la elaboración de productos. Ademas permite modificar el valor critico de cada insumo, de modo que el sistema pueda utilizar dicho valor para alertar al encargado de stock cuando la cantidad disponible de un producto descienda por debajo de dicho valor. La notificación se realiza con un mensaje en pantalla 

Para ver como funciona el control por stock critico, analicemos las siguientes FSM, en las que se modela un ingreso de pedidos que consumen cierta cantidad de un stock determinado (figura \ref{ingresoDePedidos}) por simplicidad estamos usando que solo consume cierta cantidad de un insumo, pero se puede extender relativamente facil a varios insumos. El control de stock esta modelado en la FSM de la figura \ref{stockCritico}, como vemos, el sistema permite que se ingresen pedidos, pero cuando la cantidad de stock es menor al valor critico se produce un aviso, y luego se permite igualmente seguir ingresando pedidos. Cuando el encargado de stock \ref{encargadoStock} observa el aviso puede ingresar nuevos productos aumentando el stock. Entonces el sistema vuelve a monitorear el valor del stock para avisar si queda bajo el valor critico. En particula si el encargado deja el stock en un valor inferior al critico, el sistema volvera a mostrar el mensaje de stock critico.

En estas FSM utilizamos la variable, $stock : [0..MAX]$ que comienza inicializada en STOCK un valor constante. %TODO: ver q esta inicializacion aparezca en el diagrama
Por otro lado $critico$, $k$ y $n$ son valores constantes.

\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{./figuras/fsmingresador.png}
\caption{FSM ingresar pedidos}
\label{fsmIngresoPedidos}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{./figuras/fsmstockcritico.png}
\caption{FSM aviso stock critico}
\label{fsmIngresoPedidos}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{./figuras/fsmreponerstock.png}
\caption{FSM responsable de stock}
\label{fsmIngresoPedidos}
\end{figure}
 
Entonces FSM Control de stock critico = FSM ingresar pedidos $||$ FSM aviso stock critico $||$ FSM responsable de stock

\section{Estimación de tiempos}
A continuación detallaremos las operaciones que permiten estimar el tiempo de finalización de un pedido. Notar que la misma es una estimación, no intenta ser exacta, de hecho dado que no era requerido no se tiene en cuenta el tiempo de delivery, que en general podría no ser despreciable.

Para la estimación utilizamos los tiempos de preparación y de cocción aproximados dados por el maestro al momento que se ingresa un producto al sistema.

Veamos como es para el caso de un pedido recien ingresado, ya que para los otros casos es similar solo que no se cuenta el tiempo de las etapas que ya paso.

Primero se estima su tiempo de preparacion y coccion
 
Luego se estima el tiempo de preparacion y coccion de los productos que estan adelante de el en la cola de ingreso.

Luego se hace lo mismo para los pedidos que se estan preparando

Y finalmente se estima el tiempo de cocción de los pedidos que estan en la cola del horno correspondiente al pedido y de los que se estan cocinando.

Como vemos este valor dista de ser exacto, pero de hecho no pretende serlo, sino que sirve como una estimación para el cliente.

Presentamos las operaciones a modo de quieries sin contexto que permiten estimar estos tiempos

Esta operacion nos permite obtener los pedidos que estan adelante del pedido p en la cola de preparacion

\textbf{pedidosAdelantePreparacion (p1:Pedido):set(pedido)\\}
Pedido.allInstances() \flecha  select (p $|$ p.estado = ingresado and p.posicionPreparación \flecha  asOrderedSet() \flecha  first() $<$ p.posicionPreparación \flecha asOrderedSet()\flecha first())

Esta calcula el tiempo de preparación de un pedido en base a los tiempos de sus productos

\textbf{TiempoPreparacion(p:Pedido):Integer\\}
p.productos \flecha select(pr $|$ pr.iskindof(comida)) \flecha collect(pr $|$ pr.items() \flecha select(i $|$ i.pedidos = p)  \flecha asOrderedSet() \flecha first().cantidad * pr.asOclType(comida).tiempoPreparacion) \flecha sum()

Esta operacion permite calcular el tiempo de coccion de un pedido que tiene partes ya cocinadas

\textbf{TiempoDeCocciónAlHorno(p:Pedido): Integer\\}
p.itemDe \flecha select(i $|$ i.producto.isKindOf(com)) \flecha collect(coccionDe \flecha  asOrderedSet() \flecha first()) \flecha collect(c $|$ c.itemDe.productos.\\ asOclType(Comida).tiempoCoccion * (c.itemDe.cantidad - c.cantidadCocinada)) \flecha sum() 

Esta nos permite obtener el tiempo de cocción de un pedido en base a los de sus productos

\textbf{TiempoDeCoccion(p:Pedido): Integer\\ }
p.productos \flecha select(pr $|$ pr.iskindof(comida)) \flecha collect(pr $|$ pr.items() \flecha select(i $|$ i.pedidos = p) \flecha asOrderedSet() \flecha first().cantidad * pr.asOclType(comida).tiempoCocion) \flecha sum()

Estas 3 operacinoes nos permiten conseguir a los pedidos que estan en preparacion, preparados (y esperan para el mismo horno que p tiene asignado) y por ultimo los pedidos que se estan cocinando en el horno asignado a p


\textbf{PedidosEnPreparacion() : Set(Pedido)\\}
Pedido.allInstances() \flecha select(p $|$ p.estado = En Preparacion)


\textbf{PedidosColaHorno(p:Pedido) : Set(Pedido)\\}
Pedido.allInstances() \flecha select(p1 $|$ p1.estado = Preparado and p.hornoDe = p1.hornoDe)


\textbf{PedidosHorno(p:pedido) : Set(Pedido)\\}
Pedido.allInstances() \flecha select(p1 $|$ p1.estado = Al horno and p.hornoDe = p1.hornoDe)

Estimamos entonces el tiempo hasta que p este listo

\textbf{EstimarTiempo(p: Pedido): Integer \\}
pedidosAdelantePreparacion \flecha collect(p1 $|$ TiempoDeCoccion(p1) + TiempoPrepracion(p1)) \flecha Sum() + pedidosEnPreparacion \flecha collect(p1 $|$ TiempoDeCoccion(p1) + TiempoPreparacion(p1)) \flecha Sum() + 
PedidosColaHorno(p) \flecha collect(p1 $|$ TiempoDeCoccion(p1)) +
PedidosHorno(p) \flecha collect(p1 $|$ TiempoDeCocionAlHorno(p1))
TiempoPreparacion(p) + TiempoCoccion(p)
