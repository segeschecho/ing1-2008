\section{Cancelación}

La cancelación de un pedido es un evento que puede producirse en cualquier momento de la
vida de un pedido hasta que pasa al estado finalizado. Como vimos en las secciones anteriores,
los pedidos pasan por los distintos componentes a lo largo de su estado de vida.

Para llevar a cabo una cancelación, no es suficiente con cambiar el estado del pedido
a ``Cancelado'', sino que además es necesario que el componente que está manipulando
el pedido al momento de la cancelación modifique su estado para reflejar este cambio.
Por ejemplo, un controlador de cola de horno debe retirar los elementos del pedido de las
colas correspondientes si se produce una cancelación. Por esta razón, la cancelación
afecta de alguna manera a todos los componentes del sistema, y es el único fenómeno
verdaderamente \textit{transcomponente} que debimos considerar.

Consideremos el esquema \ref{diag_componentes}, podemos ver en este diagrama como la cancelación involucra a varios componentes. El siguiente esquema intenta mostrar esta idea:

\begin{figure}[H]
\centering
\includegraphics[height=10cm]{./figuras/conCancelacion.png}
\caption{Diagrama de componentes lógicos con el evento de cancelación}
\end{figure}

Es necesario presentar a la GUI una interfaz sencilla para permitir la cancelación de un
pedido. En función de esto, la GUI permite al usuario encontrar el pedido que desea cancelar
(utilizando alguno de los métodos de búsqueda) y luego envía un mensaje a una entidad idónea
para realizar la tarea.
%FIXME: que onda con esto de los metodos de busqueda

En este punto nos encontramos con una dificultad particular: ¿Cuál es esta entidad? Es claro
que no puede elegirse arbitrariamente alguno de los componentes del sistema puesto que no
es fácil determinar cuál de ellos está ocupándose del pedido en un momento dado. Consideramos 
entonces varias opciones.

En primer lugar evaluamos agregar un método \verb0cancelar(Pedido)0 en el CoordinadorDePedidos,
\textit{façade} principal del sistema, que luego se encargue de determinar al componente
responsable de la cancelación y le envíe la notificación correspondiente. A su vez, para determinar
el responsable, consideramos dos estrategias:
\begin{itemize}
\item Propagar el mensaje desde el coordinador a todas las demás entidades, en una estrategia
      similar al \textit{flooding} en dispositivos de red. Esto tiene el problema de que no es
      limpio y no es fácil determinar qué fue lo que ocurrió con la cancelación desde el
      coordinador.
\item Definir una entidad que sea capaz de, a partir de la información de un pedido, determinar
      quién es el responsable en ese momento y enviarle un mensaje. Esto tiene el problema de que
      está fuertemente acoplado a la operatoria actual del sistema, y por lo tanto viola OCP
      ya que si se desean agregar nuevos tipos de pedido, será necesario modificar esta
      funcionalidad para que refleje las nuevas posibilidades. Para apegarse a SRP, esta funcionalidad
      ameritaría un objeto nuevo, pero esto no evita el acoplamiento que se introduce y la
      disminución de cohesión que se deriva.
\end{itemize}

Puesto que ninguna de estas opciones resultó satisfactoria, investigamos un poco más
y finalmente elegimos una opción que se asemeja al patrón \textit{Observer}. Apegándonos
a ISP, definimos una interfaz que llamamos \textbf{Cancelador} y que indica que la 
entidad que la implementa es capaz de cancelar un pedido. Le asignamos a su vez a
cada pedido un \textbf{responsable}, que no es más que una clase que implementa
la interfaz Cancelador. Cuando un componente del sistema toma el control de un pedido,
se registra como responsable del mismo. Cuando el pedido reciba una cancelación,
notificará al responsable para que este lleve a cabo la cancelación.

% TODO: si se van a pintar de algun color las clases que implementan Cancelador
% en el diagrama, aclararlo acá.
Las clases que implementan la interfaz Cancelador (y por tanto pueden
hacerse responsables de un pedido) son:
\begin{itemize}
\item ControladorEntregas
\item ControladorIngreso
\item ControladorListos
\item DespachadorPreparacion
\item DespachadorDeCoccion
\item Preparador
\end{itemize}

Esta solución es considerablemente limpia y permite fácilmente extender el sistema
sin realizar modificaciones innecesarias. Veamos a continuación algunos escenarios diferentes 
de cancelación.

\subsection{Modelado de escenarios}
\subsubsection{Cancelación de un pedido ingresado}

El primer escenario consiste en cancelar un pedido que estaba en la cola de 
ingreso. En este caso se debe sacar de dicha cola al pedido y se debe reestablecer 
el stock de los insumos que no se van a utilizar.

\begin{figure}[H]
\centering
\includegraphics[height=8cm]{./figuras/cancelacionIngreso.png}
\caption{Cancelación de un pedido ingresado}
\end{figure}

\subsubsection{Cancelación de un pedido en preparación}

En segundo lugar podemos considerar que ocurre cuando se cancela un pedido que 
estaba en preparación. En este caso puede ocurrir que el pedido se estuviera 
preparando en el momento de su cancelación, por lo que debe indicarse que se 
detenga la preparación y que se indiquen qué insumos se pueden reponer al stock.

Si la cancelación se hace para un pedido que estaba en la cola nada más, el 
proceso es muy simple, solo se desencola esta parte que estaba en espera y se corrige
el estado del Pedido. A continuación modelaremos un escenario más interesante, que corresponde
a la cancelación de un pedido que tenía sus empanadas siendo preparadas, asumiendo 
que hay otro pedido con empanadas en la cola esperando para ser preparados.

\begin{figure}[H]
\centering
\includegraphics[height=11cm]{./figuras/cancelacionPreparacion.png}
\caption{Cancelación de un pedido en preparación}
\end{figure}

\subsubsection{Cancelación de un pedido en cocción}

Otro lugar donde la cancelación es conflictiva es durante la cocción de un pedido.
Si el mismo estaba en la cola del horno, el proceso es simple porque solo hay que 
sacarlo de la misma. Por otra parte, si el pedido estaba en el horno o estaba a medio cocinar, 
hay que avisar al maestro para que retire el pedido del horno y corregir el estado de los hornos.

Vamos a modelar el escenario en el que el pedido que se cancela era un pedido a medio 
cocinar del horno 1. Entonces, hay que avisar su cancelación, y buscar un nuevo pedido 
para poner en su lugar. Vamos a suponer también que el pedido tenia dos partes en cocción, 
que no estaban en módulos ágiles y que el próximo pedido de la cola necesitaba de mas 
de 2 modulos para cocinarse.

\begin{figure}[H]
\centering
\includegraphics[height=19cm]{./figuras/cancelacionCoccion.png}
\caption{Cancelación de un pedido en cocción}
\end{figure}

el método getModulosPorPedido recorre el diccionario que guarda que pedido esta en cada módulo del horno del pedido para obtener en cuales se estaba cocinando el pedido, a fin de saber cuantos y cuales son los modulos que deben vaciarse y llenarse.

\begin{algorithm}[H]
\caption{Busca los modulos en los que se encuentra el pedido pe}
\begin{algorithmic}[1]
\PARAMS{p un pedido}
\STATE obtener la cantidad c de modulos del horno
\STATE modulo actual = primer modulo del horno de p
\WHILE{mientras hayan modulos por recorrer hacer}
\STATE obtener el pedido ped que se encuentra en el modulo i usando el diccionario
\IF{ped es p entonces}
\STATE agregar modulo actual en res
\ENDIF
\STATE modulo actual = siguiente modulo
\ENDWHILE
\RETURN res
\end{algorithmic}
\end{algorithm}

\subsubsection{Cancelación de un pedido terminado}
En el caso de que se pretanda cancelar un pedido que esta en estado finalizado, se genera una excepcion. El escenario es simple, por lo que creemos que no es necesario un diagrama de secuencias.

\subsubsection{Otros escenarios}

La notificación de cancelación se propaga a la GUI que permite al maestro
reingresar insumos recuperables. Este evento es asincrónico y la cancelación
se concreta aunque el maestro no lleve a cabo la reposición, caso en el que
se asume que nada podría reponerse.

Se pueden seguir variando los parámetros pero la secuencia sería similar. 
Finalmente, la cancelación también puede darse en el ámbito del controlador 
de entregas y del controlador de listos. En estos casos el manejo es simple, 
sin embargo, si el sistema diseñado no correspondiente a la operación de
contingencia podría existir una complejidad adicional producto de las notificaciones
al \textit{delivery}.

\subsubsection{Reponer el stock}
Cuando se produce una cancelación, puede ser necesario reponer el stock, por ejemplo si el pedido estaba ingresado y no se utilizaron sus insumos. Como creiamos que hacer que el controlador maneje esta reposicion del stock no era adecuado (viola por ejemplo el principio de SRP, el controlador de ingreso solo se encarga de los pedidos ingresados, no tiene porque conocer los mecanismos de reposisición de stock). Por eso asociamos a la interfaz cancelador un repositor de stock.

El repositor de stock tiene la responsabilidad de devolver el stock cuando un pedido se cancela. Esto lo hace segun el estado del pedido, en particular si el pedido estaba preparandose, debe pedir que se ingresen los insumos salvables. 

Entonces consideremos el caso de un pedido ingresado. Al cancelarse todo su stock se puede reutilizar, de modo que la reposicion es completa. Veamos los siguientes diagramas de secuencias:

\begin{landscape}
\begin{figure}[H]
\centering
\includegraphics[height=16cm]{./figuras/repositorPedidoIngresado.png}
\caption{Reponer stock de pedido ingresado}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}[H]
\centering
\includegraphics[height=16cm]{./figuras/repositorPedidoEnPreparacion.png}
\caption{Reponer stock de pedido en preparacion}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}[H]
\centering
\includegraphics[height=15cm]{./figuras/repositorPedidoNoIngresadoNiPreparacion.png}
\caption{Reponer stock de pedidos en otro estado distinto}
\end{figure}
\end{landscape}

En el primer diagrama vemos que el estado sea ingresado y entonces procedemos a reponer todo el stock de sus productos.

Si el pedido se estaba preparando, hay que preguntar que hacer con los productos que son preparables, es decir pedir que insumos reponer y cuales ya fueron usados, esto se puede observar en el segundo diagrama.

Finalmente si el pedido ya esta totalmente preparado, la especificación pide que solo se restablezca el stock de las bebidas. Eso es precisamente lo que se muestra en el último diagrama.

Notar que extendimos la especifiacion preguntando por los productos no preprables ni cocinables, de modo que por ejemplo si se venden por helados, al cancelar el pedido los helados se pueden reutilizar.
